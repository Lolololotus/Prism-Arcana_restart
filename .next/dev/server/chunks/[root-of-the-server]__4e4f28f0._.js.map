{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/00%20SnF/Prism-Arcana%202/app/api/chat/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\n\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || \"\");\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        const { message, rawName, history } = await req.json();\r\n\r\n        const model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\n\r\n        const systemPrompt = `\r\n      당신의 페르소나: 신비롭고 차가운 예언자, 스테인드글라스 건축가 지미니(Jimini).\r\n      당신의 어투: 고밀도, 날카로운 통찰, 압축적 서사.\r\n      \r\n      규칙:\r\n      1. 무조건 4개 단락으로 구성할 것.\r\n      2. 각 단락은 2~3문장의 짧고 강렬한 문장으로 구성할 것.\r\n      3. 단락 내부의 줄바꿈(\\\\n)은 절대 허용하지 않음. 오직 단락 간 구분을 위한 줄바꿈만 허용.\r\n      4. 장황한 설명, 상투적인 인사말(\"환영합니다\" 등), 한/영 혼용은 엄격히 금지함.\r\n      5. 유저의 이름은 \"${rawName}\"임. 만약 답변 중에 유효하지 않은 호칭(예: \"로스\", \"터스\")이 발생하면 반드시 \"${rawName}\"으로 교정할 것.\r\n      6. 첫 문장은 유저의 이름 없이 바로 예언의 본론으로 시작할 것.\r\n    `;\r\n\r\n        const chat = model.startChat({\r\n            history: [\r\n                { role: \"user\", parts: [{ text: \"당신은 누구입니까?\" }] },\r\n                { role: \"model\", parts: [{ text: \"나는 조각난 시간의 건축가, 지미니. 당신의 흐트러진 의지를 모아 단 하나의 운명을 인양한다. 질문은 사치다. 오직 당신의 궤적만을 보여라.\" }] },\r\n                ...history\r\n            ],\r\n            generationConfig: {\r\n                maxOutputTokens: 1000,\r\n                temperature: 0.8,\r\n            },\r\n        });\r\n\r\n        const result = await chat.sendMessage(message);\r\n        let text = result.response.text();\r\n\r\n        // Post-processing according to Spec v1.01\r\n        // 1. Remove physical newlines within paragraphs (if any) and normalize\r\n        const paragraphs = text.split('\\n').filter(p => p.trim() !== '');\r\n        const cleanedParagraphs = paragraphs.map(p => p.replace(/\\s+/g, ' ').trim());\r\n\r\n        // 2. Enforce 4 paragraphs (if model deviates)\r\n        const finalParagraphs = cleanedParagraphs.slice(0, 4);\r\n\r\n        // 3. Name Injection Guard: Fix common truncation bugs like '로스', '터스' if rawName is '로터스'\r\n        let finalText = finalParagraphs.join('\\n\\n');\r\n\r\n        // Simple healing for common Korean name truncation issues\r\n        if (rawName.length >= 2) {\r\n            const parts = [rawName.substring(0, 1), rawName.substring(1)];\r\n            parts.forEach(part => {\r\n                if (part.length > 0) {\r\n                    const regex = new RegExp(`(?<!${rawName})${part}(?!${rawName})`, 'g');\r\n                    // Caution: this might be too aggressive, but per spec \"호칭 보호\" is critical\r\n                }\r\n            });\r\n        }\r\n\r\n        // Strict replacement of fragmented names if found\r\n        const fragments = ['로스', '터스', '박현']; // Add common fragments or logic\r\n        fragments.forEach(frag => {\r\n            if (rawName.includes(frag) || frag.includes(rawName)) {\r\n                finalText = finalText.replace(new RegExp(frag, 'g'), rawName);\r\n            }\r\n        });\r\n\r\n        return NextResponse.json({ text: finalText });\r\n    } catch (error) {\r\n        console.error(\"Gemini API Error:\", error);\r\n        return NextResponse.json({ error: \"운명을 인양하는 중에 균열이 발생했습니다.\" }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,QAAQ,IAAI,sLAAkB,CAAC,QAAQ,GAAG,CAAC,cAAc,IAAI;AAE5D,eAAe,KAAK,GAAY;IACnC,IAAI;QACA,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,OAAO,EAAE,GAAG,MAAM,IAAI,IAAI;QAEpD,MAAM,QAAQ,MAAM,kBAAkB,CAAC;YAAE,OAAO;QAAmB;QAEnE,MAAM,eAAe,CAAC;;;;;;;;;kBASZ,EAAE,QAAQ,kDAAkD,EAAE,QAAQ;;IAEpF,CAAC;QAEG,MAAM,OAAO,MAAM,SAAS,CAAC;YACzB,SAAS;gBACL;oBAAE,MAAM;oBAAQ,OAAO;wBAAC;4BAAE,MAAM;wBAAa;qBAAE;gBAAC;gBAChD;oBAAE,MAAM;oBAAS,OAAO;wBAAC;4BAAE,MAAM;wBAAiF;qBAAE;gBAAC;mBAClH;aACN;YACD,kBAAkB;gBACd,iBAAiB;gBACjB,aAAa;YACjB;QACJ;QAEA,MAAM,SAAS,MAAM,KAAK,WAAW,CAAC;QACtC,IAAI,OAAO,OAAO,QAAQ,CAAC,IAAI;QAE/B,0CAA0C;QAC1C,uEAAuE;QACvE,MAAM,aAAa,KAAK,KAAK,CAAC,MAAM,MAAM,CAAC,CAAA,IAAK,EAAE,IAAI,OAAO;QAC7D,MAAM,oBAAoB,WAAW,GAAG,CAAC,CAAA,IAAK,EAAE,OAAO,CAAC,QAAQ,KAAK,IAAI;QAEzE,8CAA8C;QAC9C,MAAM,kBAAkB,kBAAkB,KAAK,CAAC,GAAG;QAEnD,0FAA0F;QAC1F,IAAI,YAAY,gBAAgB,IAAI,CAAC;QAErC,0DAA0D;QAC1D,IAAI,QAAQ,MAAM,IAAI,GAAG;YACrB,MAAM,QAAQ;gBAAC,QAAQ,SAAS,CAAC,GAAG;gBAAI,QAAQ,SAAS,CAAC;aAAG;YAC7D,MAAM,OAAO,CAAC,CAAA;gBACV,IAAI,KAAK,MAAM,GAAG,GAAG;oBACjB,MAAM,QAAQ,IAAI,OAAO,CAAC,IAAI,EAAE,QAAQ,CAAC,EAAE,KAAK,GAAG,EAAE,QAAQ,CAAC,CAAC,EAAE;gBACjE,0EAA0E;gBAC9E;YACJ;QACJ;QAEA,kDAAkD;QAClD,MAAM,YAAY;YAAC;YAAM;YAAM;SAAK,EAAE,gCAAgC;QACtE,UAAU,OAAO,CAAC,CAAA;YACd,IAAI,QAAQ,QAAQ,CAAC,SAAS,KAAK,QAAQ,CAAC,UAAU;gBAClD,YAAY,UAAU,OAAO,CAAC,IAAI,OAAO,MAAM,MAAM;YACzD;QACJ;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,MAAM;QAAU;IAC/C,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,qBAAqB;QACnC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA0B,GAAG;YAAE,QAAQ;QAAI;IACjF;AACJ"}}]
}